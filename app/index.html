<!DOCTYPE html>
<html ng-app="rdx">
<head>
  <link rel="stylesheet" href="bootstrap-css-only/css/bootstrap.css">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>

  <div ng-controller="UserController">
    <script type="text/ng-template" id="loginModalContent.html">
      <div class="modal-header">
        <h1>Please Sign In</h1>
      </div>
      <div class="modal-body">
        <form name="form" class="form-horizontal" ng-submit="submit(form.$valid)" novalidate>
          <div class="form-group" ng-class="{ 'has-error' : submitted && form.username.$invalid }">
            <div class="col-xs-8 col-xs-offset-2">
              <label class="control-label">Username</label>
              <input class="form-control" ng-model="user.username" type="text" name="username" placeholder="Username" required />
            </div>
          </div>
          <div class="form-group" ng-class="{ 'has-error' : submitted && form.password.$invalid}">
            <div class="col-xs-8 col-xs-offset-2">
              <label class="control-label">Password</label>
              <input class="form-control" ng-model="user.password" type="password" name="password" placeholder="Password" required />
            </div>
          </div>
          <div class="form-group has-error">
            <div class="col-xs-8 col-xs-offset-2">
              <span ng-show="message" class="help-block">{{message}}</span>
            </div>
          </div>
          <div class="form-group">
            <div class="col-xs-8 col-xs-offset-2">
              <input id="login-button" class="btn btn-primary btn-lg" type="submit" value="Login" />
            </div>
          </div>
        </form>
      </div>
    </script>
  </div>

  <script>

    var UserController = function($rootScope, $scope, $modal) {
      $rootScope.$on('event:auth-loginRequired', function() {
        console.log('loginRequired');
        show();
      });

      $scope.user = {};

      show = function() {
        var modalInstance = $modal.open({
          templateUrl: 'loginModalContent.html',
          controller: LoginModalController,
          resolve: {
            user: function () {
              return $scope.user;
            }
          }
        });

        modalInstance.result.then(function () {
          console.log('Modal closed at: ' + new Date());
        }, function () {
          console.log('Modal dismissed at: ' + new Date());
          $scope.$state.go('home');
        });
      };
    };

    var LoginModalController = function($scope, $modalInstance, AuthService, user) {
      $scope.message = '';
      $scope.submitted = false;

      $scope.user = user;

      $scope.submit = function(isValid) {
        $scope.submitted = true;

        if (isValid) {
          AuthService.authenticate($scope.user).then(success, error);
        }
        else if (angular.isUndefined($scope.user.username)) {
          $scope.message = 'Enter your username';
        }
        else if (angular.isUndefined($scope.user.password)) {
          $scope.message = 'Enter your password';
        }
      }

      // ** authentication handlers ** //
      success = function(resp) {
        console.log('AuthService.authenticate success resp: ' + angular.toJson(resp));
        $scope.submitted = false;
        $modalInstance.close();
      };

      error = function(resp) {
        console.log('AuthService.authenticate failure resp: ' + angular.toJson(resp));
        if (resp.data != undefined) {
          $scope.user.password = '';
          $scope.message = resp.data;
        }
      };
    };
  </script>

  <div id="content">
    <nav class="navbar navbar-inverse" role="navigation">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">AngularRDX</a>
    </div>
    <ul class="nav navbar-nav">
      <li ng-class="{ active: $state.includes('cases') }"><a ui-sref="cases.list">Cases</a></li>
      <li ng-class="{ active: $state.current.name == 'about' }"><a ui-sref="about">About</a></li>
    </ul>
    <div class="navbar-right">
      <p ng-if="$state.includes('cases') && user.name" class="navbar-text">Signed in as {{user.name}} </p>
    </div>
    </nav>

    <div class="container">

      <div ui-view>
      </div>

    </div>
  </div>

  <div class="footer">
    <div class="container">
      <p>LifeInCoolTech</p>
      <h6><small>Life Insurance and Cool Technology</small></h6>
    </div>
  </div>

  <script src="angular/angular.js"></script>
  <script src="angular-bootstrap/ui-bootstrap-tpls.js"></script>
  <script src="angular-ui-router/release/angular-ui-router.js"></script>
  <script src="angular-animate/angular-animate.js"></script>
  <script src="angular-http-auth/src/http-auth-interceptor.js"></script>
  <script src="js/app.js"></script>
  <script src="js/auth/auth-service.js"></script>
  <script src="js/auth/auth-directive.js"></script>
  <script src="js/users/user-controller.js"></script>
  <script src="js/home/home-controller.js"></script>
  <script src="js/interview/interview-service.js"></script>
  <script src="js/cases/cases.js"></script>
  <script src="js/cases/cases-service.js"></script>
  <script src="js/cases/cases-controller.js"></script>
  <script src="js/interview/interview.js"></script>
  <script src="js/interview/interview-controller.js"></script>
  <script src="js/interview/interview-step-controllers.js"></script>
  <script src="js/quotes/quotes-service.js"></script>
</body>
</html>
